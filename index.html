<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 員工國外旅遊：韓國濟州島之旅</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- 🎨 原始配色方案 --- */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #073B4C;
            color: #E0F2F1;
            line-height: 1.7;
        }
        .gradient-text {
            background: linear-gradient(45deg, #FFD166, #06D6A0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            background-color: rgba(17, 138, 178, 0.1);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 1rem;
        }
        .card:hover {
            transform: translateY(-6px);
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
        }
        .countdown-segment {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: #FF6B6B;
            color: #FFFFFF;
            border-radius: 0.5rem; font-weight: 700; font-size: 1.75rem;
            min-width: 65px; height: 70px; text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); line-height: 1.1;
        }
        .countdown-label { 
            font-size: 0.8rem; 
            color: #FFFFFF;
            margin-top: 0.2rem; 
            font-weight: 500; 
        }
        .info-list-item {
            display: flex;
            align-items: flex-start;
            font-size: 1rem;
            color: #E0F2F1;
            margin-bottom: 0.75rem;
        }
        .info-list-item::before {
            content: '•';
            color: #06D6A0;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            flex-shrink: 0;
            margin-right: 0.6em;
            font-size: 1.2em;
            line-height: 1.5;
        }
        .passport-info-item {
            display: flex;
            align-items: flex-start;
            font-size: 0.95rem;
            color: #E0F2F1;
            margin-bottom: 0.6rem;
        }
        .passport-info-item::before {
            content: '📌';
            display: inline-block;
            width: 1.5em;
            flex-shrink: 0;
            margin-right: 0.5em;
        }

        input[type="checkbox"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            border: 2px solid #118AB2; transition: all 0.2s ease-in-out;
            outline: none; cursor: pointer; position: relative;
            border-radius: 4px; width: 1.25rem; height: 1.25rem;
        }
        input[type="checkbox"]:checked {
            background-color: #06D6A0; border-color: #06D6A0;
            box-shadow: 0 0 0 3px rgba(6, 214, 160, 0.4);
        }
        input[type="checkbox"]:checked::before {
            content: '✓'; color: #073B4C; font-weight: bold; font-size: 0.8rem;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        input[type="checkbox"]:disabled {
            border-color: #4B5563;
            background-color: #374151;
            cursor: not-allowed;
        }
        label.inline-flex span { transition: color 0.2s ease-in-out; }
        input[type="checkbox"]:checked + span { color: #FFD166; font-weight: 600; }
        .form-input {
            background-color: rgba(0,0,0,0.2); border: 1px solid #118AB2;
            border-radius: 0.5rem; padding: 0.5rem 0.75rem;
            color: white; width: 100%;
        }
        .card-header {
            font-size: 1.75rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
            text-align: center;
            color: #FFD166;
        }
        #submitBtn {
            background-color: #06D6A0;
            color: #073B4C;
        }
        #submitBtn:hover {
            background-color: #FFD166;
        }
        #submitBtn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        #formStatus strong {
            color: #FFD166;
        }
        /* --- Progress Bar Styles --- */
        .progress-bar-container {
            background-color: #073B4C;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid #118AB2;
        }
        .progress-bar-fill {
            background: linear-gradient(90deg, #FFD166, #06D6A0);
            padding: 0.5rem;
            text-align: right;
            color: #073B4C;
            font-weight: bold;
            transition: width 0.5s ease-in-out;
        }
        /* --- Plan Highlight Style --- */
        .plan-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .active-plan {
            border-color: #FFD166;
            box-shadow: 0 0 20px rgba(255, 209, 102, 0.4);
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <div class="container mx-auto max-w-5xl">
        <header class="text-center my-8 md:my-12">
            <h1 class="text-4xl md:text-6xl font-black gradient-text leading-tight">2025 員工國外旅遊</h1>
            <p class="text-2xl md:text-4xl font-bold text-white mt-2">韓國濟州島之旅 🇰🇷</p>
        </header>

        <main class="space-y-8">
            
            <section class="card p-6 md:p-8">
                <h2 class="card-header">旅行摘要</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="text-center md:text-left">
                        <div class="mb-6"><h3 class="text-lg font-bold text-white">旅行日期</h3><p class="text-3xl font-black text-[#06D6A0]">2025年 11月 10日 (一) - 11月 14日 (五)</p><p class="text-gray-300">五天四夜，享受海島風光</p></div>
                        <div class="p-4 rounded-lg bg-black/10"><h3 class="text-lg font-bold text-white">報名倒數中 <span class="text-[#FF6B6B]">(本週日截止)</span></h3><div id="countdownTimer" class="flex justify-center md:justify-start items-start mt-2 space-x-2 md:space-x-3"></div></div>
                    </div>
                    <div class="space-y-4 p-4 rounded-lg bg-black/10">
                        <div class="text-center"><h3 class="text-lg font-bold text-white">✈️ 去程 TPE → CJU</h3><p class="text-2xl font-bold text-white">14:25 - 17:30</p><p class="text-sm text-gray-400">德威航空 TW688</p></div>
                        <hr class="border-gray-700">
                        <div class="text-center"><h3 class="text-lg font-bold text-white">✈️ 回程 CJU → TPE</h3><p class="text-2xl font-bold text-white">12:20 - 13:25</p><p class="text-sm text-gray-400">德威航空 TW687</p></div>
                    </div>
                </div>
            </section>

            <section class="card p-6 md:p-8">
                <h2 class="card-header">詳細行程</h2>
                <div class="space-y-6">
                    <div class="p-4 border-l-4 border-[#06D6A0] bg-black/10 rounded-r-lg"><h3 class="text-xl font-bold text-white mb-2">第一天：桃園國際機場/濟州國際機場→龍頭岩+龍淵峽谷</h3><p class="text-gray-300">桃園國際機場/濟州國際機場→龍頭岩+龍淵峽谷(巨大火山岩/海蝕地形)→享用晚餐→入住飯店 CHECKIN→享用飯店設施</p><p class="text-sm italic text-[#FFD166] mt-2">早餐:X | 午餐:花花小點心 | 晚餐:三姓穴海鮮鍋料理 (W22,500韓幣/人)</p><p class="text-sm text-gray-400 mt-2">住宿: 市區四星 韋斯立飯店 WHISTLE LARK 或同等級</p></div>
                    <div class="p-4 border-l-4 border-[#06D6A0] bg-black/10 rounded-r-lg"><h3 class="text-xl font-bold text-white mb-2">第二天：城山日出峰→萬丈窟→濟州城邑民俗村→東門市場</h3><p class="text-gray-300">飯店→城山日出峰(火山丘/世界自然遺產)→萬丈窟(世界上最長的熔岩洞)→濟州城邑民俗村(贈每人一杯蜂蜜茶或五味子茶)→東門市場+中央地下街+黑豬肉一條街→返回飯店休憩</p><p class="text-sm italic text-[#FFD166] mt-2">早餐:飯店內用 | 午餐:石鍋拌飯+涮涮鍋 (W10,000韓幣/人) | 晚餐:明倫進士碳烤黑毛豬肉吃到飽+季節小菜 (W18,900韓幣/人)</p><p class="text-sm text-gray-400 mt-2">住宿: 市區四星 韋斯立飯店 WHISTLE LARK 或同等級</p></div>
                    <div class="p-4 border-l-4 border-[#06D6A0] bg-black/10 rounded-r-lg"><h3 class="text-xl font-bold text-white mb-2">第三天：ECOLAND森林小火車→漢拏樹木園→天地淵瀑布</h3><p class="text-gray-300">飯店→ECOLAND 森林小火車(森林趣/風車/海盜船/彩虹躺椅/哈比人樹洞)→漢拏樹木園(十一個主題園區)→天地淵瀑布(大長今場景/上帝的池塘)→濟州有林橘子(贈每人5顆橘子)→返回飯店休憩</p><p class="text-sm italic text-[#FFD166] mt-2">早餐:飯店內用 | 午餐:青花魚定食 (₩11,000韓幣/人) | 晚餐:活鮑魚+碳烤黑毛豬+蝦+蛋+大醬 (₩24,000韓幣/人)</p><p class="text-sm text-gray-400 mt-2">住宿: 市區四星 韋斯立飯店 WHISTLE LARK 或同等級</p></div>
                    <div class="p-4 border-l-4 border-[#06D6A0] bg-black/10 rounded-r-lg"><h3 class="text-xl font-bold text-white mb-2">第四天：全日自由活動</h3><p class="text-gray-300">飯店→全日自由活動→返回飯店休憩</p><p class="text-sm italic text-[#FFD166] mt-2">早餐:飯店內用 | 午、晚餐:方便遊玩,敬請自理</p><p class="text-sm text-gray-400 mt-2">住宿: 市區四星 韋斯立飯店 WHISTLE LARK 或同等級</p></div>
                    <div class="p-4 border-l-4 border-[#06D6A0] bg-black/10 rounded-r-lg"><h3 class="text-xl font-bold text-white mb-2">第五天：返回溫暖的家</h3><p class="text-gray-300">飯店出發→濟州國際機場/桃園國際機場→歡樂賦歸</p><p class="text-sm italic text-[#FFD166] mt-2">早餐:飯店內用 | 午餐:X | 晚餐:X</p><p class="text-sm text-gray-400 mt-2">住宿: 溫暖的家</p></div>
                </div>
            </section>
            
            <section class="card p-6 md:p-8">
                <h2 class="card-header">費用試算 & 線上報名</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="space-y-2"><h3 class="text-xl font-bold text-white mb-4">💰 費用規則</h3>
                        <div class="info-list-item"><div><strong>公司補助：</strong><br>正式員工補助 <strong class="text-[#06D6A0]">$30,000</strong> 元。<br>外包人員補助 50% (<strong class="text-[#06D6A0]">$15,000</strong> 元)。</div></div>
                        <div class="info-list-item"><div><strong>正式員工自付：</strong><br><ul class="list-disc list-inside pl-2 text-gray-300"><li>總人數 > 20：自付 $2,900</li><li>總人數 16-20：自付 $3,900</li></ul></div></div>
                        <div class="info-list-item"><div><strong>眷屬補助：</strong><br>業績達標者，可為<strong class="text-white">一位同行眷屬</strong> (成人或孩童) 申請 <strong class="text-[#FFD166]">$15,000 元補助</strong>！<br><span class="text-sm text-gray-400">(外包人員不適用)</span></div></div>
                        <div class="info-list-item"><div><strong>其他優惠：</strong><br><ul class="list-disc list-inside pl-2 text-gray-300"><li>孩童不佔床：團費減 $1,000</li><li>嬰兒價：$6,500</li><li>單人房：需補價差 $9,000</li></ul></div></div>
                    </div>
                    <div class="space-y-2"><h3 class="text-xl font-bold text-white mb-4">📩 報名流程</h3><div class="info-list-item"><div><strong>步驟一：</strong><br>填寫您與所有同行眷屬的資料，並勾選相關選項。</div></div><div class="info-list-item"><div><strong>步驟二：</strong><br>點擊「送出報名」，確認資料送出成功。</div></div><div class="info-list-item"><div><strong>步驟三 (重要)：</strong><br>請將所有人的<strong class="text-[#FFD166]">護照照片電子檔</strong>，LINE 給<strong class="text-[#FFD166]">主辦人</strong>。</div></div><div class="info-list-item"><div><strong>取消政策：</strong><br>報名後取消，需自付機票取消費 <strong class="text-[#FF6B6B]">$9,000 - $12,000</strong> 元。</div></div></div>
                </div>
                <hr class="border-gray-700/50 mb-8">

                <!-- Progress Bar Section -->
                <div id="progress-container" class="mb-8 p-4 rounded-lg bg-black/20 text-center hidden">
                    <h3 id="progress-title" class="text-xl font-bold text-white mb-2"></h3>
                    <div class="progress-bar-container">
                        <div id="progress-bar-fill" class="progress-bar-fill"></div>
                    </div>
                    <p id="progress-text" class="mt-2 text-lg"></p>
                </div>

                <form id="registrationForm" class="space-y-6">
                    <h3 class="text-2xl font-bold text-center text-white">費用試算 & 報名表</h3>
                    
                    <fieldset class="p-4 border border-gray-600 rounded-lg"><legend class="px-2 text-lg font-semibold text-white">1. 同行人數 (員工本人免填)</legend><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2"><div><label for="numAdults" class="block text-sm font-medium text-gray-300 mb-1">眷屬 (成人)</label><input type="number" id="numAdults" class="form-input" value="0" min="0"></div><div><label for="numChildren" class="block text-sm font-medium text-gray-300 mb-1">孩童 (不佔床)</label><input type="number" id="numChildren" class="form-input" value="0" min="0"></div><div><label for="numInfants" class="block text-sm font-medium text-gray-300 mb-1">嬰兒 (2歲以下)</label><input type="number" id="numInfants" class="form-input" value="0" min="0"></div></div></fieldset>
                    
                    <input type="hidden" id="hiddenAdults" name="adults">
                    <input type="hidden" id="hiddenChildren" name="children">
                    <input type="hidden" id="hiddenInfants" name="infants">

                    <fieldset class="p-4 border border-gray-600 rounded-lg"><legend class="px-2 text-lg font-semibold text-white">2. 您的資料</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
                            <div><label for="regName" class="block text-sm font-medium text-gray-300 mb-1">您的姓名</label><input type="text" id="regName" name="employee_name" class="form-input" placeholder="請輸入中文姓名" required></div>
                            <div><label class="block text-sm font-medium text-gray-300 mb-1">出生年月日</label><input type="date" name="employee_dob" class="form-input" required></div>
                        </div>
                        <div class="mt-4">
                            <label class="inline-flex items-center cursor-pointer"><input type="checkbox" name="employee_renew_passport"><span class="ml-3 text-white">需要新辦/換新護照</span></label>
                        </div>
                    </fieldset>
                    
                    <div id="companionSection" class="space-y-6"></div>

                    <fieldset class="p-4 border border-gray-600 rounded-lg"><legend class="px-2 text-lg font-semibold text-white">3. 整體選項</legend>
                        <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-8 mt-2 justify-center">
                            <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="isOutsourced" name="is_outsourced"><span class="ml-3 text-white">我是外包人員</span></label>
                            <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="performanceBonus" name="bonus"><span class="ml-3 text-white">去年業績達標 (享眷屬補助)</span></label>
                            <label class="inline-flex items-center cursor-pointer"><input type="checkbox" id="singleRoom" name="single_room"><span class="ml-3 text-white">需要單人房 (補價差$9,000)</span></label>
                        </div>
                    </fieldset>

                    <div id="costResult" class="text-center bg-black/20 p-6 rounded-lg border border-white/10 min-h-[120px] flex flex-col justify-center"><p class="text-gray-400">請填寫人數，下方將顯示費用預估</p></div>
                    <button type="submit" id="submitBtn" class="w-full font-bold py-3 px-8 rounded-lg transition-colors duration-300 text-lg">
                        送出報名
                    </button>
                    <div id="formStatus" class="text-center mt-4 h-6"></div>
                </form>
            </section>
            
            <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="card p-6"><h3 class="text-xl font-bold text-center mb-4 text-white">團費包含項目</h3><div class="space-y-2 text-gray-200"><p class="info-list-item">交通費：行程表內團體遊覽車，德威航空來回經濟艙團體機票。</p><p class="info-list-item">稅捐：各地機場稅、燃料稅、稅金。</p><p class="info-list-item">餐食：行程內列明之餐食，盡量安排適合國人口味。</p><p class="info-list-item">住宿：行程表內飯店住宿（兩人一室為原則），需達 10 間以上。</p><p class="info-list-item">遊覽費：行程內旅遊活動之門票、手續費。</p><p class="info-list-item">保險費：每人全程旅遊責任保險新台幣伍佰萬元及貳十萬元意外醫療險。</p><p class="info-list-item">贈禮：花花專屬贈品、旅遊手冊、企業紀念布條、花花筆、夾鏈袋、網卡。</p><p class="info-list-item">小費：司機、領隊、導遊小費 (每日 NT$300 x 5 天，共 NT$1,500/人，已包含)。</p><p class="info-list-item">領隊導遊：達 16 人以上派遣合格專業領隊 1 位，當地導遊 1 位。</p><p class="info-list-item">飲用水：礦泉水無限提供。</p></div></div>
                <div class="card p-6"><h3 class="text-xl font-bold text-center mb-4 text-white">團費未含項目</h3><div class="space-y-2 text-gray-200"><p class="info-list-item">證照費：新辦 (換新) 十年效期護照費用 NT$1,600 元。</p><p class="info-list-item">證照費：14 歲以下五年效期護照費用 NT$1,200 元。</p><p class="info-list-item">純係私人之消費：如電話費、洗衣費等。</p><p class="info-list-item">床頭、行李小費及表上未列明之其他行程自費行程。</p><p class="info-list-item">旅遊平安保險及旅遊不便險等其他私人保險項目。</p></div></div>
            </section>
            
            <section class="card p-6 md:p-8">
                <h2 class="card-header">護照換發準備資料</h2>
                <div class="text-center mb-6 bg-yellow-900/30 text-yellow-300 p-3 rounded-lg">
                    <p>外交部工作天數約為 12-15 個工作天 (不含假日)，身份證則須 4-6 個工作天後回件。</p>
                    <p>如需使用到身份證正本，再請特別留意唷！</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-black/10 p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-white mb-4 text-center">成人</h3>
                        <div class="space-y-2 text-gray-200">
                           <p class="passport-info-item">護照申請書 (公司有可填寫)</p>
                           <p class="passport-info-item">半年內的兩吋白底大頭照 2 張</p>
                           <p class="passport-info-item">身分證正本</p>
                           <p class="passport-info-item">舊護照 (建議可帶來方便確認英文別名，避免勾選錯誤浪費送件時間)</p>
                           <p class="passport-info-item">人別確認 (首次申辦才需檢附)</p>
                           <p class="passport-info-item">費用: 1600 元 (專案優惠價)</p>
                        </div>
                    </div>
                    <div class="bg-black/10 p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-white mb-4 text-center">滿 14-18 歲</h3>
                        <div class="space-y-2 text-gray-200">
                           <p class="passport-info-item">護照申請書 (公司有可填寫)</p>
                           <p class="passport-info-item">半年內拍的兩吋白底大頭照 2 張</p>
                           <p class="passport-info-item">身分證正本及監護人身份證正本 (若有監護權問題，需提供三個月內戶籍謄本正本一份)</p>
                           <p class="passport-info-item">舊護照 (建議可帶來方便確認英文別名，避免勾選錯誤浪費送件時間)</p>
                           <p class="passport-info-item">人別確認 (首次申辦才需檢附)</p>
                           <p class="passport-info-item">費用: 1600 元 (專案優惠價)</p>
                        </div>
                    </div>
                    <div class="bg-black/10 p-4 rounded-lg">
                         <h3 class="text-xl font-bold text-white mb-4 text-center">14 歲以下</h3>
                        <div class="space-y-2 text-gray-200">
                           <p class="passport-info-item">護照申請書 (公司有可填寫)</p>
                           <p class="passport-info-item">半年内拍的兩吋白底大頭照 2 張</p>
                           <p class="passport-info-item">戶口名簿正本 (記事不可省略) 或 3 個月內辦理之戶籍謄本(詳細記事)正本</p>
                           <p class="passport-info-item">舊護照 (建議可帶來方便確認英文別名)</p>
                           <p class="passport-info-item">監護人身份證正本</p>
                           <p class="passport-info-item">人別確認 (首次申辦才需檢附)</p>
                           <p class="passport-info-item">費用: 1200 元 (專案優惠價)</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const regForm = document.getElementById('registrationForm');
        const resultDiv = document.getElementById('costResult');
        const numAdultsInput = document.getElementById('numAdults');
        const numChildrenInput = document.getElementById('numChildren');
        const numInfantsInput = document.getElementById('numInfants');
        const companionSection = document.getElementById('companionSection');
        const hiddenAdultsInput = document.getElementById('hiddenAdults');
        const hiddenChildrenInput = document.getElementById('hiddenChildren');
        const hiddenInfantsInput = document.getElementById('hiddenInfants');
        const nameInput = document.getElementById('regName');
        const isOutsourcedCheckbox = document.getElementById('isOutsourced');
        const performanceBonusCheckbox = document.getElementById('performanceBonus');
        
        const progressContainer = document.getElementById('progress-container');
        const progressTitle = document.getElementById('progress-title');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const progressText = document.getElementById('progress-text');
        
        let serverHeadcount = 0; // To store headcount from server
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxbbw0aqiY4zAQs7dsTeHh2KzaeAk5Mr851fcYAnIld20rt3r0Jv4AfJp7ocnn91g8W/exec';

        function generateCompanionFields() {
            const adults = parseInt(numAdultsInput.value) || 0;
            const children = parseInt(numChildrenInput.value) || 0;
            const infants = parseInt(numInfantsInput.value) || 0;
            hiddenAdultsInput.value = adults;
            hiddenChildrenInput.value = children;
            hiddenInfantsInput.value = infants;
            let companionHtml = '';
            
            const createCompanionFieldset = (type, index) => {
                const typeText = { adult: '成人', child: '孩童', infant: '嬰兒' }[type];
                return `
                    <fieldset class="p-4 border border-gray-600/50 rounded-lg">
                        <legend class="px-2 text-md font-semibold text-white">眷屬 (${typeText}) ${index} 資料</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
                           <div><label class="block text-sm font-medium text-gray-300 mb-1">姓名</label><input type="text" name="${type}_${index}_name" class="form-input" placeholder="請輸入中文姓名" required></div>
                           <div><label class="block text-sm font-medium text-gray-300 mb-1">出生年月日</label><input type="date" name="${type}_${index}_dob" class="form-input" required></div>
                        </div>
                        <div class="mt-4">
                           <label class="inline-flex items-center cursor-pointer"><input type="checkbox" name="${type}_${index}_renew_passport"><span class="ml-3 text-white">需要新辦/換新護照</span></label>
                        </div>
                    </fieldset>`;
            };

            for (let i = 1; i <= adults; i++) {
                companionHtml += createCompanionFieldset('adult', i);
            }
            for (let i = 1; i <= children; i++) {
                companionHtml += createCompanionFieldset('child', i);
            }
            for (let i = 1; i <= infants; i++) {
                companionHtml += createCompanionFieldset('infant', i);
            }
            companionSection.innerHTML = companionHtml;
            regForm.querySelectorAll('#companionSection input').forEach(input => {
                input.addEventListener('change', calculateTotalCost);
            });
        }
        
        function getAge(dateString) {
            if (!dateString) return 99;
            const today = new Date();
            const birthDate = new Date(dateString);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function handleSpecialConditions() {
            const employeeName = nameInput.value.trim();
            const isOutsourced = isOutsourcedCheckbox.checked;

            const forcedBonusUsers = ['張菲比', '王唯菱', '方成霖'];
            const isForcedBonusUser = forcedBonusUsers.includes(employeeName);
            const isZhang = employeeName === '張仲宇';

            performanceBonusCheckbox.disabled = false;

            if (isForcedBonusUser) {
                performanceBonusCheckbox.checked = true;
                performanceBonusCheckbox.disabled = true;
            } else if (isZhang && isOutsourced) {
                performanceBonusCheckbox.checked = true;
                performanceBonusCheckbox.disabled = true;
            } else if (isOutsourced) {
                performanceBonusCheckbox.checked = false;
                performanceBonusCheckbox.disabled = true;
            }
            calculateTotalCost();
        }

        function updateProgressBar(currentCount) {
            const targetCount = 21;
            const percentage = Math.min((currentCount / targetCount) * 100, 100);
            
            progressContainer.classList.remove('hidden');
            progressTitle.innerText = `目前報名進度 (${currentCount} / ${targetCount} 人)`;
            progressBarFill.style.width = `${percentage}%`;
            progressBarFill.innerText = `${Math.round(percentage)}%`;

            if (currentCount >= targetCount) {
                progressText.innerText = '目標達成！已解鎖全體優惠價！';
                progressText.style.color = '#06D6A0';
            } else {
                const remaining = targetCount - currentCount;
                progressText.innerText = `還差 ${remaining} 人即可解鎖全體優惠價！`;
                progressText.style.color = '#FF6B6B';
            }
        }

        function calculateTotalCost() {
            const scenarios = {
                planB: { base: 3900, label: "若總人數16-20位" },
                planA: { base: 2900, label: "若總人數>20位" }
            };

            const employeeName = nameInput.value.trim();
            const isLiao = employeeName === '廖彤婕';
            const isZhang = employeeName === '張仲宇';
            const isZhangYiKai = employeeName === '張逸凱';
            const isPhoebe = employeeName === '張菲比';
            const isWeiLing = employeeName === '王唯菱';
            const isChengLin = employeeName === '方成霖';
            const isOutsourced = isOutsourcedCheckbox.checked;
            
            const formAdults = parseInt(numAdultsInput.value) || 0;
            const formChildren = parseInt(numChildrenInput.value) || 0;
            const formTotal = 1 + formAdults + formChildren; 
            const totalHeadcount = serverHeadcount + formTotal;

            let finalHtml = '';
            
            for (const scenarioKey in scenarios) {
                const scenario = scenarios[scenarioKey];
                
                const hasBonusCheckbox = performanceBonusCheckbox.checked;
                const numAdults = parseInt(numAdultsInput.value) || 0;
                const numChildren = parseInt(numChildrenInput.value) || 0;
                const numInfants = parseInt(numInfantsInput.value) || 0;
                const needsSingleRoom = document.getElementById('singleRoom').checked;

                let employeeCompanySubsidy = 30000;
                if (isOutsourced && !isZhang) {
                    employeeCompanySubsidy = 15000;
                }

                const baseEmployeeCost = scenario.base;
                const companionBaseCost = baseEmployeeCost + 30000; 
                const infantCost = 6500;
                const singleRoomSupplement = 9000;
                const adultPassportFee = 1600;
                const childPassportFee = 1200;
                
                let subTotal = 0;
                let passportTotalCost = 0;
                let breakdownHtml = '<div class="text-left text-sm space-y-1 mt-3">';

                const employeeSelfPay = companionBaseCost - employeeCompanySubsidy;
                subTotal += employeeSelfPay;
                breakdownHtml += `<p>• 員工本人團費：<span class="font-bold text-white">${companionBaseCost.toLocaleString()}</span> 元</p>`;
                breakdownHtml += `<p class="pl-4">└─ 公司補助：<span class="font-bold text-green-400">-${employeeCompanySubsidy.toLocaleString()}</span> 元</p>`;

                if (numAdults > 0) {
                    subTotal += numAdults * companionBaseCost;
                    breakdownHtml += `<p>• 眷屬 (成人 ${numAdults}位)：<span class="font-bold text-white">${(numAdults * companionBaseCost).toLocaleString()}</span> 元</p>`;
                }
                if (numChildren > 0) {
                    subTotal += numChildren * companionBaseCost;
                    breakdownHtml += `<p>• 孩童 (${numChildren}位)：<span class="font-bold text-white">${(numChildren * companionBaseCost).toLocaleString()}</span> 元</p>`;
                }
                if (numInfants > 0) {
                    subTotal += numInfants * infantCost;
                    breakdownHtml += `<p>• 嬰兒 (${numInfants}位)：<span class="font-bold text-white">${(numInfants * infantCost).toLocaleString()}</span> 元</p>`;
                }

                if (numChildren > 0 || hasBonusCheckbox || (isLiao && (numAdults>0 || numChildren>0)) ) {
                     breakdownHtml += `<hr class="border-gray-600 my-2">`;
                     breakdownHtml += `<p class="text-gray-400">折扣與補助：</p>`;
                }

                const standardChildDiscountTotal = 1000 * numChildren;
                if (standardChildDiscountTotal > 0) {
                    subTotal -= standardChildDiscountTotal;
                    breakdownHtml += `<p class="pl-4">└─ 孩童不佔床折扣：<span class="font-bold text-green-400">-${standardChildDiscountTotal.toLocaleString()}</span> 元</p>`;
                }

                if (isLiao) {
                    let specialChildCount = 0;
                    for (let i = 1; i <= numChildren; i++) {
                        const childDob = regForm.querySelector(`[name="child_${i}_dob"]`)?.value;
                        if (getAge(childDob) < 4) {
                            specialChildCount++;
                        }
                    }
                    if (specialChildCount > 0) {
                        const specialChildDiscountTotal = 2500 * specialChildCount;
                        subTotal -= specialChildDiscountTotal;
                        breakdownHtml += `<p class="pl-4 text-yellow-400">└─ ⭐ 彤婕專屬-孩童加碼：<span class="font-bold">-${specialChildDiscountTotal.toLocaleString()}</span> 元</p>`;
                    }
                }
                
                if (numAdults > 0 || numChildren > 0) {
                    if (hasBonusCheckbox) {
                        if (isZhangYiKai) {
                            breakdownHtml += `<p class="pl-4 text-red-400">└─ ⭐ 已將折扣給廖彤婕使用</p>`;
                        } else if (!isOutsourced || isZhang) {
                            const standardBonus = 15000;
                            subTotal -= standardBonus;
                            breakdownHtml += `<p class="pl-4">└─ 業績達標補助：<span class="font-bold text-green-400">-${standardBonus.toLocaleString()}</span> 元</p>`;
                            
                            if (isPhoebe) {
                                breakdownHtml += `<p class="pl-4 text-yellow-400">  (⭐ 上山下海拍影片特別補助)</p>`;
                            } else if (isWeiLing) {
                                breakdownHtml += `<p class="pl-4 text-yellow-400">  (⭐ 廣告費不給花特別補助)</p>`;
                            } else if (isChengLin) {
                                breakdownHtml += `<p class="pl-4 text-yellow-400">  (⭐ 公司有事沒事特別補助)</p>`;
                            }

                            if (isLiao) {
                                const specialBonus = 5000;
                                subTotal -= specialBonus;
                                breakdownHtml += `<p class="pl-4 text-yellow-400">└─ ⭐ 彤婕專屬-達標加碼：<span class="font-bold">-${specialBonus.toLocaleString()}</span> 元</p>`;
                            }
                        }
                    } else if (isLiao) {
                        const specialBonus = 5000;
                        subTotal -= specialBonus;
                        breakdownHtml += `<p class="pl-4 text-yellow-400">└─ ⭐ 彤婕專屬-特別補助：<span class="font-bold">-${specialBonus.toLocaleString()}</span> 元</p>`;
                    }
                }
                
                const employeeDob = regForm.querySelector('[name="employee_dob"]')?.value;
                if (regForm.querySelector('[name="employee_renew_passport"]')?.checked) {
                    passportTotalCost += (getAge(employeeDob) < 14 ? childPassportFee : adultPassportFee);
                }
                for (let i = 1; i <= numAdults; i++) {
                    if (regForm.querySelector(`[name="adult_${i}_renew_passport"]`)?.checked) {
                        const dob = regForm.querySelector(`[name="adult_${i}_dob"]`)?.value;
                        passportTotalCost += (getAge(dob) < 14 ? childPassportFee : adultPassportFee);
                    }
                }
                for (let i = 1; i <= numChildren; i++) {
                    if (regForm.querySelector(`[name="child_${i}_renew_passport"]`)?.checked) {
                        passportTotalCost += childPassportFee;
                    }
                }
                for (let i = 1; i <= numInfants; i++) {
                    if (regForm.querySelector(`[name="infant_${i}_renew_passport"]`)?.checked) {
                        passportTotalCost += childPassportFee;
                    }
                }

                if (needsSingleRoom || passportTotalCost > 0) {
                    breakdownHtml += `<hr class="border-gray-600 my-2">`;
                    breakdownHtml += `<p class="text-gray-400">其他費用：</p>`;
                }
                
                if (needsSingleRoom) {
                    subTotal += singleRoomSupplement;
                    breakdownHtml += `<p class="pl-4">└─ 單人房價差：<span class="font-bold text-white">+${singleRoomSupplement.toLocaleString()}</span> 元</p>`;
                }
                
                if (passportTotalCost > 0) {
                    breakdownHtml += `<p class="pl-4">└─ 護照辦理費：<span class="font-bold text-amber-300">+${passportTotalCost.toLocaleString()}</span> 元</p>`;
                }

                let grandTotal = subTotal + passportTotalCost;
                
                breakdownHtml += '</div>';

                finalHtml += `
                    <div id="plan-${scenarioKey}-card" class="plan-card flex-1 p-4 rounded-lg ${scenarioKey === 'planA' ? 'bg-green-500/10' : 'bg-yellow-500/10'}">
                        <p class="font-bold ${scenarioKey === 'planA' ? 'text-green-300' : 'text-yellow-300'}">${scenario.label}費用明細：</p>
                        ${breakdownHtml}
                        <hr class="border-gray-500/50 my-3">
                        <p class="font-bold text-white text-right">總計：<span class="text-2xl font-black">${grandTotal.toLocaleString()}</span> 元</p>
                    </div>`;
            }
            resultDiv.innerHTML = `<div class="flex flex-col md:flex-row gap-4">${finalHtml}</div>`;
            
            // FIX: Highlight the active plan AFTER the HTML is rendered
            document.getElementById('plan-planA-card')?.classList.toggle('active-plan', totalHeadcount > 20);
            document.getElementById('plan-planB-card')?.classList.toggle('active-plan', totalHeadcount <= 20);
        }
        
        function handleHeadcountResponse(data) {
            if (data && data.status === 'success') {
                serverHeadcount = data.totalCount;
                updateProgressBar(serverHeadcount);
                calculateTotalCost(); 
            } else {
                console.error("Failed to fetch headcount:", data ? data.message : "No data returned");
                progressContainer.classList.remove('hidden');
                progressTitle.innerText = "無法取得即時報名人數";
            }
            const scriptTag = document.getElementById('jsonp-script');
            if (scriptTag) {
                scriptTag.parentNode.removeChild(scriptTag);
            }
        }
        
        function fetchHeadcount() {
            const oldScript = document.getElementById('jsonp-script');
            if (oldScript) {
                oldScript.parentNode.removeChild(oldScript);
            }
            
            const script = document.createElement('script');
            script.id = 'jsonp-script';
            script.src = scriptURL + "?action=getcount&callback=handleHeadcountResponse&t=" + new Date().getTime(); 
            
            script.onerror = () => {
                console.error("Error fetching headcount: Script load failed.");
                progressContainer.classList.remove('hidden');
                progressTitle.innerText = "無法取得即時報名人數";
                const scriptTag = document.getElementById('jsonp-script');
                if (scriptTag && scriptTag.parentNode) {
                    scriptTag.parentNode.removeChild(scriptTag);
                }
            };
            
            document.body.appendChild(script);
        }
        
        nameInput.addEventListener('input', handleSpecialConditions);
        isOutsourcedCheckbox.addEventListener('change', handleSpecialConditions);
        numAdultsInput.addEventListener('input', () => { generateCompanionFields(); calculateTotalCost(); });
        numChildrenInput.addEventListener('input', () => { generateCompanionFields(); calculateTotalCost(); });
        numInfantsInput.addEventListener('input', () => { generateCompanionFields(); calculateTotalCost(); });
        
        regForm.addEventListener('change', (event) => {
            const noTriggerIds = ['regName', 'isOutsourced', 'numAdults', 'numChildren', 'numInfants'];
            if (!noTriggerIds.includes(event.target.id)) {
                calculateTotalCost();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
             generateCompanionFields();
             handleSpecialConditions();
             fetchHeadcount();
        });
        
        const form = document.getElementById('registrationForm');
        const submitBtn = document.getElementById('submitBtn');
        const formStatus = document.getElementById('formStatus');

        form.addEventListener('submit', e => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = '傳送中...';
            formStatus.textContent = '';
            
            fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                .then(response => response.json())
                .then(data => {
                    if(data.result === 'success'){
                        formStatus.innerHTML = `報名成功！<br>請記得將所有人的護照照片 <strong>LINE 給主辦人</strong>。`;
                        formStatus.style.color = '#06D6A0';
                        form.reset();
                        generateCompanionFields();
                        handleSpecialConditions();
                        fetchHeadcount(); 
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    formStatus.textContent = '報名失敗，請稍後再試或聯繫主辦人。';
                    formStatus.style.color = '#FF6B6B';
                    console.error('Error!', error.message);
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '送出報名';
                });
        });
        
        const countdownTimerElement = document.getElementById('countdownTimer');
        const today = new Date();
        const dayOfWeek = today.getDay(); 
        const daysUntilSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
        const deadlineDate = new Date(today);
        deadlineDate.setDate(today.getDate() + daysUntilSunday);
        deadlineDate.setHours(23, 59, 59, 999);

        const updateCountdown = () => {
            const now = new Date().getTime();
            const distance = deadlineDate.getTime() - now;
            if (distance < 0) {
                clearInterval(countdownInterval);
                countdownTimerElement.innerHTML = '<span class="text-xl font-bold text-white">報名已截止！</span>';
                return;
            }
            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);
            countdownTimerElement.innerHTML = `
                <div class="countdown-segment"><span>${d.toString().padStart(2, '0')}</span><span class="countdown-label">天</span></div>
                <div class="countdown-segment"><span>${h.toString().padStart(2, '0')}</span><span class="countdown-label">時</span></div>
                <div class="countdown-segment"><span>${m.toString().padStart(2, '0')}</span><span class="countdown-label">分</span></div>
                <div class="countdown-segment"><span>${s.toString().padStart(2, '0')}</span><span class="countdown-label">秒</span></div>`;
        };
        const countdownInterval = setInterval(updateCountdown, 1000);
        updateCountdown();
    </script>
</body>
</html>
